<!--

    ***************************************************************************
    Copyright (c) 2010 Qcadoo Limited
    Project: Qcadoo MES
    Version: 1.1.3

    This file is part of Qcadoo.

    Qcadoo is free software; you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation; either version 3 of the License,
    or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty
    of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
    ***************************************************************************

-->
<view name="costCalculationDetails" modelName="costCalculation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schema.qcadoo.org/view"
	xsi:schemaLocation="http://schema.qcadoo.org/view http://schema.qcadoo.org/view.xsd">

	<component type="window" name="window" reference="window">
		<ribbon>
			<template name="standardFormTemplate" />
			<group name="generate">
				<bigButton name="generate" icon="generateIcon24.png"
					action="#{form}.fireEvent(generateCostCalculation);" state="disabled">
					<script>
						<![CDATA[
						#{form}.addOnChangeListener({
							onSetValue: function(value) {
								if (! value || ! value.content) {
									return;
								}
								if (! value.content.entityId) {
									this.disable();
								} else {
									this.enable();
								}
							}
						});	
						]]>
					</script>
				</bigButton>
			</group>
			<group name="export">
				<bigButton name="pdf" icon="pdfIcon16.png"
					action="#{form}.fireEvent(printCostCalculation,pdf);" state="disabled" />
			</group>
		</ribbon>
		<windowTab name="mainTab">
			<component type="form" name="orderId" reference="orderId"
				defaultVisible="false" />
			<component type="form" name="technologyId" reference="technologyId"
				defaultVisible="false" />
			<component type="form" name="form" reference="form">
				<script>
				<![CDATA[
				
					jQuery(document).ready(function() {
						var json = JSON.parse(context);
						var orderId = json['window.mainTab.orderId'];
						var technologyId = json['window.mainTab.technologyId'];
						
						if (orderId != null) {
							#{form}.fireEvent(this, 'requestCopyFieldValues', ['order', orderId]);
						} else if (technologyId != null) {
							#{form}.fireEvent(this, 'requestCopyFieldValues', ['technology', technologyId]); 
						}
					});
									
					
					var pdfRibbonItem = #{window}.getRibbonItem("export.pdf");
					var saveRibbonItem = #{window}.getRibbonItem("actions.save");
					var saveBackRibbonItem = #{window}.getRibbonItem("actions.saveBack");
					var saveNewRibbonItem = #{window}.getRibbonItem("actions.saveNew");
					var copyRibbonItem = #{window}.getRibbonItem("actions.copy");
					
					var generatedRibbonItem =  #{window}.getRibbonItem("generate.generate");
					
					var entityExists = false;
					
					this.addOnChangeListener({
						onSetValue: function(value) {
							if (!value || !value.content) {
								return;
							}
							if (value.content.entityId) {
								entityExists = true;
							} else {
								entityExists = false;
							}
							updateRibbon();
						}
					});
					#{form}.addOnChangeListener({
						onSetValue: function(value) {
							updateRibbon();
						}
					});
					
					function updateRibbon() {
						if (entityExists) {
							var isGeneratedCheckboxValue = #{generated}.getValue();
							generatedRibbonItem.enable();
							saveRibbonItem.disable();
							if (isGeneratedCheckboxValue && isGeneratedCheckboxValue.content.value == "1") {
								pdfRibbonItem.enable();
								generatedRibbonItem.disable();
								saveRibbonItem.disable("#{translate(costCalculation.ribbon.message.recordAlreadyGenerated)}");
								saveBackRibbonItem.disable("#{translate(costCalculation.ribbon.message.recordAlreadyGenerated)}");
								saveNewRibbonItem.disable("#{translate(costCalculation.ribbon.message.recordAlreadyGenerated)}");
							} else {
								pdfRibbonItem.disable("#{translate(costCalculation.ribbon.message.recordNotGenerated)}");
								saveRibbonItem.enable();
							}
						} else {
							copyRibbonItem.disable("#{translate(recordNotCreated)}");
							pdfRibbonItem.disable("#{translate(recordNotCreated)}");
							saveRibbonItem.enable();
						}
					}
				]]>
				</script>

				<component type="gridLayout" name="gridLayout" columns="3"
					rows="6">
					<layoutElement column="1" row="1">
						<component type="checkbox" name="generated" field="generated"
							reference="generated" defaultEnabled="false" />
					</layoutElement>
					<layoutElement column="1" row="2">
						<component type="input" name="dateOfCalculation" field="dateOfCalculation"
							reference="dateOfCalculation" defaultEnabled="false" />
					</layoutElement>
					<layoutElement column="1" row="3">
						<component type="input" name="number" field="number"
							reference="number">
							<option type="alignment" value="right" />
						</component>
					</layoutElement>
					<layoutElement column="1" row="4" height="3">
						<component type="textarea" name="description" field="description" reference="description"
							height="3" />
					</layoutElement>
					<layoutElement column="2" row="1">
						<component type="lookup" name="order" field="order"
							reference="order">
							<option type="column" name="name" fields="name" link="true" />
							<option type="required" value="true" />
							<option type="searchable" value="name" />
							<option type="orderable" value="name" />
							<option type="expression"
								value="'&lt;b&gt;' + #number + '&lt;/b&gt; - ' + #name" />
							<option type="fieldCode" value="number" />
							<listener event="onSelectedEntityChange"
								class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
								method="fillFieldWhenOrderChanged" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="2">
						<component type="lookup" name="product" field="product"
							reference="product">
							<option type="column" name="name" fields="name" link="true" />
							<option type="required" value="true" />
							<option type="searchable" value="name" />
							<option type="orderable" value="name" />
							<option type="expression" value="#name" />
							<option type="fieldCode" value="number" />
							<listener event="onSelectedEntityChange"
								class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
								method="changeOrderProduct" />
							<listener event="onSelectedEntityChange"
								class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
								method="fillCostPerUnitUnitField" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="3">
						<component type="lookup" name="defaultTechnology" field="defaultTechnology"
							reference="defaultTechnology" defaultEnabled="false">
							<option type="column" name="name" fields="name" />
							<option type="required" value="true" />
							<option type="searchable" value="name" />
							<option type="orderable" value="name" />
							<option type="expression" value="#name" />
							<option type="fieldCode" value="number" />
						</component>

					</layoutElement>
					<layoutElement column="2" row="4">
						<component type="lookup" name="technology" field="technology"
							reference="technology">
							<option type="column" name="name" fields="name" link="true" />
							<option type="required" value="true" />
							<option type="searchable" value="name" />
							<option type="orderable" value="name" />
							<option type="expression" value="#number + ' ' + #name" />
							<option type="fieldCode" value="number" />
							<listener event="onSelectedEntityChange"
								class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
								method="fillFieldWhenTechnologyChanged" />
						</component>

					</layoutElement>
					<layoutElement column="2" row="5">
						<component type="input" name="quantity" field="quantity"
							reference="quantity">
							<option type="alignment" value="right" />
						</component>
					</layoutElement>
				</component>

				<option type="header" value="true" />
				<option type="expression" value="#name" />

				<listener event="generateCostCalculation"
					class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
					method="generateCostCalculation" />
				<listener event="requestCopyFieldValues"
					class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
					method="copyFieldValues" />
				<listener event="printCostCalculation"
					class="com.qcadoo.mes.costCalculation.print.CostCalculationReportService"
					method="printCostCalculationReport" />

			</component>
		</windowTab>
		<windowTab name="inputDataTab">
			<component type="form" name="formInputData" reference="formInputData">
				<component type="gridLayout" name="inputData" reference="inputData"
					columns="3" rows="5">
					<layoutElement column="1" row="1" height="5">
						<component type="borderLayout" name="borderLayoutParameters"
							reference="borderLayoutParameters">
							<option type="label" value="parameters" />
							<component type="gridLayout" name="parameters"
								reference="parameters" columns="1" rows="5">
								
								
								<layoutElement column="1" row="1">
									<component type="select" name="sourceOfMaterialcosts"
										reference="sourceOfMaterialcosts" field="#{form}.sourceOfMaterialcosts" >
									<listener event="onSelectedEntityChange" class ="com.qcadoo.mes.costCalculation.CostCalculationViewService" method="ifCurrentGlobalIsSelected"/>
										</component>
								</layoutElement>
								<layoutElement column="1" row="2">
									<component type="select" name="calculateMaterialCostsMode"
										reference="calculateMaterialCostsMode" field="#{form}.calculateMaterialCostsMode" >
										<listener event="onSelectedEntityChange" class ="com.qcadoo.mes.costCalculation.CostCalculationViewService" method="ifCurrentGlobalIsSelected"/>
										</component>
								</layoutElement>
								<layoutElement column="1" row="3">
									<component type="select" name="calculateOperationCostsMode"
										reference="calculateOperationCostsMode" field="#{form}.calculateOperationCostsMode" >
										<listener event="onSelectedEntityChange" class ="com.qcadoo.mes.costCalculation.CostCalculationViewService" method="disableCheckboxIfPieceworkSelected"/>
										</component>
								</layoutElement>
								<layoutElement column="1" row="4">
									<component type="checkbox" name="includeTPZ"
										reference="includeTPZ" field="#{form}.includeTPZ" />
								</layoutElement>
								<layoutElement column="1" row="5">
									<component type="checkbox" name="includeAdditionalTime"
										reference="includeAdditionalTime" field="#{form}.includeAdditionalTime" />
								</layoutElement>
								
							</component>
						</component>
					</layoutElement>
					<layoutElement column="2" row="1" height="3">
						<component type="borderLayout" name="borderLayoutOverheads"
							reference="borderLayoutOverheads">
							<option type="label" value="overheads" />
							<component type="gridLayout" name="overheads"
								reference="overheads" columns="4" rows="3" hasBorders="false">
								<layoutElement column="1" row="1" width="3">
									<component type="input" name="productionCostMargin"
										field="#{form}.productionCostMargin" reference="productionCostMargin">
										<option type="alignment" value="right" />
									</component>
								</layoutElement>
								<layoutElement column="4" row="1">
									<component type="input" name="productionCostMarginProc"
										defaultEnabled="false" hasLabel="false" reference="productionCostMarginProc">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="2" width="3">
									<component type="input" name="materialCostMargin"
										field="#{form}.materialCostMargin" reference="materialCostMargin">
										<option type="alignment" value="right" />
									</component>
								</layoutElement>
								<layoutElement column="4" row="2">
									<component type="input" name="materialCostMarginProc"
										defaultEnabled="false" hasLabel="false" reference="materialCostMarginProc">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="3" width="3">
									<component type="input" name="additionalOverhead"
										field="#{form}.additionalOverhead" reference="additionalOverhead">
										<option type="alignment" value="right" />
									</component>
								</layoutElement>
								<layoutElement column="4" row="3">
									<component type="input" name="additionalOverheadCurrency"
										defaultEnabled="false" hasLabel="false" reference="additionalOverheadCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
							</component>
						</component>
					</layoutElement>
				</component>
			</component>
		</windowTab>
		<windowTab name="calculationResultsTab">
			<component type="form" name="formCalculationResults"
				reference="formCalculationResults">
				<component type="gridLayout" name="calculationResults"
					reference="calculationResults" columns="3" rows="6">
					<layoutElement column="1" row="1" height="6">
						<component type="borderLayout" name="borderLayoutTechnicalProductionCost"
							reference="borderLayoutTechnicalProductionCost">
							<option type="label" value="technicalProductionCost" />
							<component type="gridLayout" name="gridTechnicalProductionCost"
								columns="3" rows="6" hasBorders="false">
								<layoutElement column="1" row="1" width="2">
									<component type="input" name="totalMaterialCosts"
										field="#{form}.totalMaterialCosts" reference="totalMaterialCosts"
										defaultEnabled="false">
										  <option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="1">
									<component type="input" name="totalMaterialCostsCurrency"
										defaultEnabled="false" hasLabel="false" reference="totalMaterialCostsCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="2" width="2">
									<component type="input" name="totalMachineHourlyCosts"
										reference="totalMachineHourlyCosts" field="#{form}.totalMachineHourlyCosts"
										defaultEnabled="false">
										  <option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="2">
									<component type="input" name="totalMachineHourlyCostsCurrency"
										defaultEnabled="false" hasLabel="false"
										reference="totalMachineHourlyCostsCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="3" width="2">
									<component type="input" name="totalLaborHourlyCosts"
										field="#{form}.totalLaborHourlyCosts" reference="totalLaborHourlyCosts"
										defaultEnabled="false">
										  <option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="3">
									<component type="input" name="totalLaborHourlyCostsCurrency"
										defaultEnabled="false" hasLabel="false"
										reference="totalLaborHourlyCostsCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="4" width="2">
									<component type="input" name="totalPieceworkCosts"
										field="#{form}.totalPieceworkCosts" reference="totalPieceworkCosts"
										defaultEnabled="false" defaultVisible="false">
										  <option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="4">
									<component type="input" name="totalPieceworkCostsCurrency"
										defaultEnabled="false" hasLabel="false" reference="totalPieceworkCostsCurrency" defaultVisible="false">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="5">
									<component type="label" name="totalTechnicalProductionCostsLabel">
										<option type="labelStyle" value="text" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="6" width="2">
									<component type="input" name="totalTechnicalProductionCosts"
										reference="totalTechnicalProductionCosts" field="#{form}.totalTechnicalProductionCosts"
										defaultEnabled="false" hasLabel="false">
										<option type="textRepresentationOnDisabled" value="true" />
										<option type="alignment" value="right" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="6">
									<component type="input"
										name="totalTechnicalProductionCostsCurrency" defaultEnabled="false"
										hasLabel="false" reference="totalTechnicalProductionCostsCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
							</component>
						</component>
					</layoutElement>
					<layoutElement column="2" row="1" height="6">
						<component type="borderLayout" name="borderLayoutOverheadsValue"
							reference="borderLayoutOverheadsValue">
							<option type="label" value="overheadsValue" />
							<component type="gridLayout" name="gridProductionCostMargin"
								columns="3" rows="5" hasBorders="false">
								<layoutElement column="1" row="1" width="2">
									<component type="input" name="productionCostMarginValue"
										field="#{form}.productionCostMarginValue" defaultEnabled="false"
										reference="productionCostMarginValue">
										<option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="1">
									<component type="input" name="productionCostMarginValueCurrency"
										defaultEnabled="false" hasLabel="false"
										reference="productionCostMarginValueCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="2" width="2">
									<component type="input" name="materialCostMarginValue"
										field="#{form}.materialCostMarginValue" defaultEnabled="false"
										reference="materialCostMarginValue">
										<option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="2">
									<component type="input" name="materialCostMarginValueCurrency"
										defaultEnabled="false" hasLabel="false"
										reference="materialCostMarginValueCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="3" width="2">
									<component type="input" name="additionalOverheadValue"
										field="#{form}.additionalOverheadValue" defaultEnabled="false"
										reference="additionalOverheadValue">
										<option type="labelWidth" value="40"/>
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="3">
									<component type="input" name="additionalOverheadValueCurrency"
										defaultEnabled="false" hasLabel="false"
										reference="additionalOverheadValueCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="4">
									<component type="label" name="totalOverheadLabel"
										hasLabel="false">
									  <option type="labelWidth" value="40"/>
										<option type="labelStyle" value="text" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="5" width="2">
									<component type="input" name="totalOverhead" field="#{form}.totalOverhead"
										defaultEnabled="false" reference="totalOverhead" hasLabel="false">
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="5">
									<component type="input" name="totalOverheadCurrency"
										defaultEnabled="false" hasLabel="false" reference="totalOverheadCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
							</component>
						</component>
					</layoutElement>
					<layoutElement column="3" row="1" height="6">
						<component type="borderLayout" name="totalCost"
							reference="totalCost">
							<option type="label" value="totalCost" />
							<component type="gridLayout" name="gridProductionCostMargin"
								columns="3" rows="4" hasBorders="false">
								<layoutElement column="1" row="1" width="2">
									<component type="label" name="totalCostLabel"
										hasLabel="false">
										<option type="labelStyle" value="text" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="2" width="2">
									<component type="input" name="totalCosts" field="#{form}.totalCosts"
										defaultEnabled="false" reference="totalCosts" hasLabel="false">
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="2">
									<component type="input" name="totalCostsCurrency"
										defaultEnabled="false" hasLabel="false" reference="totalCostsCurrency">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="3">
									<component type="label" name="costPerUnitLabel"
										hasLabel="false">
										<option type="labelStyle" value="text" />
									</component>
								</layoutElement>
								<layoutElement column="1" row="4" width="2">
									<component type="input" name="costPerUnit" field="#{form}.costPerUnit"
										defaultEnabled="false" reference="costPerUnit" hasLabel="false">
										<option type="alignment" value="right" />
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
								<layoutElement column="3" row="4">
									<component type="input" name="totalCostsPerUnitUNIT"
										defaultEnabled="false" hasLabel="false" reference="totalCostsPerUnitUNIT">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
							</component>
						</component>
					</layoutElement>
				</component>
			</component>
		</windowTab>
	</component>
	<hooks>
		<beforeRender
			class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
			method="setFieldEnable" />
		<beforeRender
			class="com.qcadoo.mes.costCalculation.CostCalculationViewService"
			method="fillCurrencyFields" />
	</hooks>
</view>

