<?xml version="1.0" encoding="UTF-8"?>
<!--

    ***************************************************************************
    Copyright (c) 2010 Qcadoo Limited
    Project: Qcadoo MES
    Version: 1.2.0

    This file is part of Qcadoo.

    Qcadoo is free software; you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation; either version 3 of the License,
    or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty
    of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
    ***************************************************************************

-->
<view xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schema.qcadoo.org/view"
	xsi:schemaLocation="http://schema.qcadoo.org/view http://schema.qcadoo.org/view.xsd"
	name="orderDetails" modelName="order">

	<component type="window" name="window" reference="window">

		<ribbon>
			<template name="standardFormTemplate" />
			<group name="status">
				<smallButton name="acceptOrder" icon="startIcon16.png"
					state="disabled">
					<script>
						<![CDATA[
						
							this.addOnChangeListener({
								onClick: function() {
									if (this.state == "accept") {
										if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.acceptOrder.confirm)}")) {
											#{form}.performEvent('changeState', ['02accepted']);
										};
									} else if (this.state == "begin") {
										if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.activateOrder.confirm)}")) {
											#{form}.performEvent('changeState', ['03inProgress']);
										};
									} else if (this.state == "finish") {
										if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.finishOrder.confirm)}")) {
											#{form}.performEvent('changeState', ['04completed']);
										};
									} else if (this.state == "restart") {
										if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.restartOrder.confirm)}")) {
											#{form}.performEvent('changeState', ['03inProgress']);
										};
									}
								}
							});
							]]>
					</script>
				</smallButton>
				<smallButton name="declineOrder" icon="deleteIcon16.png"
					state="disabled">
					<script>
					<![CDATA[
						this.addOnChangeListener({
							onClick: function() {
								if (this.state == "decline") {
									if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.declineOrder.confirm)}")) {
										#{form}.performEvent('changeState', ['05declined']);
									};
								} else if (this.state == "abandon") {
									if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.abandonOrder.confirm)}")) {
										#{form}.performEvent('changeState', ['07abandoned']);
									};
								}
							}
						});
							]]>
					</script>
				</smallButton>
				<smallButton name="interruptOrder" icon="pauseIcon16.png"
					state="disabled">
					<script>
						<![CDATA[
						this.addOnChangeListener({
							onClick: function() {
								if (window.confirm("#{translate(orders.ordersPlanningList.window.ribbon.status.interruptOrder.confirm)}")) {
									#{form}.performEvent('changeState', ['06interrupted']);
								};
							}
						});
						]]>
					</script>
				</smallButton>
			</group>
			<group name="export">
				<bigButton name="print" icon="pdfIcon24.png"
					action="#{form}.generateReportForEntity('orders','order','pdf')" />
			</group>
			<group name="orderParameters">
				<bigButton name="orderParameters" icon="settingsIcon24.png"
					state="disabled">
					<script>
						<![CDATA[
							this.addOnChangeListener({
								onClick: function() {
										if(window.canClose()) {
											#{form}.performEvent('showOrderParameters', []);
										}
								}
							});		
							#{form}.addOnChangeListener({
								onSetValue: function(value) {
									if (! value || ! value.content) {
										return;
									}
									if (! value.content.entityId) {
										this.disable();
									} else {
										this.enable();
									}
								}
							});					
						]]>
					</script>
				</bigButton>
			</group>
		</ribbon>

		<windowTab name="mainTab">
			<component type="form" name="order" reference="form">
				<script>
					<![CDATA[
					
						var url = parent.document.URL;
						var urlWithoutHostname = url.replace (/^[a-z]{4}\:\/{2}[a-z]{1,}\:[0-9]{1,4}.(.*)/, '$1');
					
						if(parent.mixpanel){
							#{window}.getRibbonItem("actions.save").addOnChangeListener({
								onClick: function() {
									
									if ( #{form}.getComponentValue().entityId) {
									
										parent.mixpanel.track("modifyOrder",
											{'username' : parent.window.getCurrentUserLogin(),
											 'url':       urlWithoutHostname}
										);
									
									} else {
									
										parent.mixpanel.track("addOrder",
											{'username' : parent.window.getCurrentUserLogin(),
											 'url':       urlWithoutHostname}
										);
										
									}
								}
							});
						}
					
					
					var save = #{window}.getRibbonItem("actions.save");
					var saveBack = #{window}.getRibbonItem("actions.saveBack");
					var saveNew = #{window}.getRibbonItem("actions.saveNew");
					var cancel = #{window}.getRibbonItem("actions.cancel");
					var del = #{window}.getRibbonItem("actions.delete");
					var acceptOrder = #{window}.getRibbonItem("status.acceptOrder");
					var declineOrder = #{window}.getRibbonItem("status.declineOrder");
					var interruptOrder = #{window}.getRibbonItem("status.interruptOrder");
					this.addOnChangeListener({
					onSetValue: function(value) {
						if (! value || ! value.content) {
						return;
						}
						save.enable();
						saveBack.enable();
						saveNew.enable();
						if (! value.content.entityId) {
							cancel.disable();
							del.disable();
							acceptOrder.disable();
							declineOrder.disable();
							interruptOrder.disable();
							return;
						}
						cancel.enable();
						del.enable();
						var state = #{state}.getValue().content.value;
						var externalSynchronized = #{externalSynchronized}.getValue().content.value;
						if (!state) {
							return;
						}
						if (state == "01pending") {
							acceptOrder.enable();
							acceptOrder.state = "accept";
							acceptOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.acceptOrder)}");
							acceptOrder.setIcon('startIcon16.png');
							declineOrder.enable();
							declineOrder.state = "decline";
							declineOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.declineOrder)}");
							declineOrder.setIcon('deleteIcon16.png');
							interruptOrder.disable();
						} else if (state == "02accepted") {
							acceptOrder.enable();
							acceptOrder.state = "begin";
							acceptOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.activateOrder)}");
							acceptOrder.setIcon('startIcon16.png');
							declineOrder.enable();
							declineOrder.state = "decline";
							declineOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.declineOrder)}");
							declineOrder.setIcon('deleteIcon16.png');
							interruptOrder.disable();
							del.disable();
						} else if (state == "03inProgress") {
							acceptOrder.enable();
							acceptOrder.state = "finish";
							acceptOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.finishOrder)}");
							acceptOrder.setIcon('acceptIcon16.png');
							declineOrder.enable();
							declineOrder.state = "abandon";
							declineOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.abandonOrder)}");
							declineOrder.setIcon('deleteIcon16.png');
							interruptOrder.enable();
							del.disable();
						}  else if (state == "04completed"){ 
							cancel.disable();
							del.disable();
							acceptOrder.disable();
							declineOrder.disable();
							interruptOrder.disable()
						} else if (state == "05declined"){
							cancel.disable();
							acceptOrder.disable();
							declineOrder.disable();
							interruptOrder.disable();
						} else if (state == "06interrupted"){
							acceptOrder.enable();
							acceptOrder.state = "restart";
							acceptOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.restartOrder)}");
							acceptOrder.setIcon('acceptIcon16.png');
							declineOrder.enable();
							declineOrder.state = "abandon";
							declineOrder.setLabel("#{translate(orders.orderDetails.window.ribbon.status.abandonOrder)}");
							declineOrder.setIcon('deleteIcon16.png');
							interruptOrder.disable();
							del.disable();
						} else if (state == "07abandoned"){ 
							cancel.disable();
							del.disable();
							acceptOrder.disable();
							declineOrder.disable();
							interruptOrder.disable()
						}
						else {
							save.disable();
							saveBack.disable();
							saveNew.disable();
							cancel.disable();
							del.disable();
							acceptOrder.disable();
							declineOrder.disable();
							interruptOrder.disable();
						}
						
						if(externalSynchronized == '0') {
							save.disable("#{translate(orders.order.ribbon.message.orderIsExternal)}");
							saveBack.disable("#{translate(orders.order.ribbon.message.orderIsExternal)}");
							saveNew.disable("#{translate(orders.order.ribbon.message.orderIsExternal)}");
							cancel.disable("#{translate(orders.order.ribbon.message.orderIsExternal)}");
							del.disable("#{translate(orders.order.ribbon.message.orderIsExternal)}");
							acceptOrder.disable();
							declineOrder.disable();
							interruptOrder.disable();
						}
						
						}
					});
					]]>
				</script>
				<component type="gridLayout" name="gridLayout" columns="3"
					rows="9">
					<layoutElement column="1" row="1">
						<component type="input" name="number" reference="number"
							field="number">
							<option type="alignment" value="right" />
						</component>
						<component type="hidden" name="externalSynchronized"
							field="externalSynchronized" reference="externalSynchronized" />
					</layoutElement>
					<layoutElement column="1" row="2" height="2">
						<component type="textarea" name="name" field="name"
							reference="name" hasDescription="true" />
					</layoutElement>
					<layoutElement column="1" row="4" height="2">
						<component type="textarea" name="description" field="description"
							reference="description" />
					</layoutElement>
					<layoutElement column="1" row="6">
						<component type="lookup" name="company" reference="company"
							field="company">
							<option type="column" name="name" fields="name" />

							<option type="searchable" value="name,number" />
							<option type="orderable" value="name,number" />

							<option type="expression"
								value="'&lt;b&gt;' + #number + '&lt;/b&gt; - ' + #name" />
							<option type="fieldCode" value="number" />
						</component>
					</layoutElement>
					<layoutElement column="1" row="7">
						<component type="calendar" name="dateFrom" field="startDate"
							reference="dateFrom">
							<option type="labelWidth" value="50" />
							<option type="withTimePicker" value="true" />
							<listener event="onChange"
								class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
								method="copyStartDateToDetails" />
						</component>
					</layoutElement>
					<layoutElement column="1" row="8">
						<component type="calendar" name="dateTo" field="finishDate"
							reference="dateTo">
							<option type="labelWidth" value="50" />
							<option type="withTimePicker" value="true" />
							<listener event="onChange"
								class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
								method="copyFinishDateToDetails" />
						</component>
					</layoutElement>
					<layoutElement column="1" row="9">
						<component type="calendar" name="deadline" field="deadline"
							reference="deadline">
							<option type="labelWidth" value="50" />
							<option type="withTimePicker" value="true" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="1">
						<component type="lookup" name="product" reference="product"
							field="product">
							<option type="column" name="name" fields="name" link="true"
								width="200" />
							<option type="column" name="ean" fields="ean" />

							<option type="searchable" value="name,ean" />
							<option type="orderable" value="name,ean" />

							<option type="expression"
								value="'&lt;b&gt;' + #number + '&lt;/b&gt; - ' + #name" />
							<option type="fieldCode" value="number" />

							<listener event="onSelectedEntityChange"
								class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
								method="changeOrderProduct" />
							<listener event="onSelectedEntityChange" class="com.qcadoo.mes.basic.util.UnitService"
								method="fillProductUnit" />
							<listener event="onSelectedEntityChange" class="com.qcadoo.mes.orders.OrderService"
								method="setDefaultNameUsingTechnology" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="2">
						<component type="input" name="defaultTechnology"
							reference="defaultTechnology" field="defaultTechnology"
							defaultEnabled="false" />
					</layoutElement>
					<layoutElement column="2" row="3">
						<component type="lookup" name="technology" reference="technology"
							field="technology" source="#{product}.technologies">
							<option type="column" name="name" fields="name" link="true"
								width="300" />

							<option type="searchable" value="name,number" />
							<option type="orderable" value="name,number" />

							<option type="expression"
								value="'&lt;b&gt;' + #number + '&lt;/b&gt; - ' + #name" />
							<option type="fieldCode" value="number" />

							<listener event="onSelectedEntityChange" class="com.qcadoo.mes.orders.OrderService"
								method="setDefaultNameUsingTechnology" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="4">
						<component type="lookup" name="productionLine"
							reference="productionLine" field="productionLine">
							<option type="column" name="name" fields="name" link="true"
								width="300" />

							<option type="searchable" value="name,number" />
							<option type="orderable" value="name,number" />

							<option type="expression"
								value="'&lt;b&gt;' + #number + '&lt;/b&gt; - ' + #name" />
							<option type="fieldCode" value="number" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="5">
						<component type="select" name="state" field="state"
							reference="state" defaultVisible="false" />
					</layoutElement>
					<layoutElement column="2" row="6">
						<component type="input" name="plannedQuantity"
							reference="plannedQuantity" field="plannedQuantity">
							<option type="labelWidth" value="55" />
							<option type="alignment" value="right" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="7">
						<component type="input" name="doneQuantity" field="doneQuantity"
							reference="doneQuantity" hasDescription="true">
							<option type="labelWidth" value="55" />
							<option type="alignment" value="right" />
						</component>
					</layoutElement>
					<layoutElement column="2" row="8">
						<component type="input" name="unit" reference="unit"
							defaultEnabled="false">
							<option type="labelWidth" value="55" />
							<option type="alignment" value="right" />
						</component>
					</layoutElement>
				</component>

				<option type="header" value="true" />
				<option type="expression"
					value="#name + ' - ' + #number + ' - ' + '@orders.order.state.value.' + #state" />

				<listener event="changeState"
					class="com.qcadoo.mes.orders.states.client.OrderStateChangeViewClient"
					method="changeState" />
				<listener event="showOrderParameters" method="showOrderParameters"
					class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners" />
			</component>
		</windowTab>

		<windowTab name="detailsTab">
			<component type="gridLayout" name="detailsTablayout"
				columns="3" rows="1">
				<layoutElement column="1" row="1">
					<component type="borderLayout" name="startDates">
						<component type="gridLayout" name="startDatesGridLayout"
							columns="1" rows="3" reference="startDatesGridLayout">
							<layoutElement column="1" row="1">
								<component type="calendar" name="plannedDateFrom"
									field="#{form}.dateFrom" reference="plannedDateFrom"
									defaultEnabled="false">
									<option type="withTimePicker" value="true" />

									<listener event="onChange"
										class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
										method="copyStartDate" />
								</component>
							</layoutElement>
							<layoutElement column="1" row="2">
								<component type="calendar" name="correctedDateFrom"
									field="#{form}.correctedDateFrom" reference="correctedDateFrom"
									defaultEnabled="false">
									<option type="withTimePicker" value="true" />

									<listener event="onChange"
										class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
										method="copyStartDate" />
								</component>
							</layoutElement>
							<layoutElement column="1" row="3">
								<component type="calendar" name="effectiveDateFrom"
									field="#{form}.effectiveDateFrom" reference="effectiveDateFrom"
									defaultEnabled="false">
									<option type="withTimePicker" value="true" />

									<listener event="onChange"
										class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
										method="copyStartDate" />
								</component>
							</layoutElement>
						</component>

						<option type="label" value="startDatesLabel" />
					</component>
					<component type="borderLayout" name="causeOfPlannedDateFromCorrection">
						<component type="gridLayout"
							name="causeOfPlannedDateFromCorrectionGridLayout" columns="1"
							rows="3" reference="causeOfPlannedDateFromCorrectionGridLayout">
							<layoutElement column="1" row="1">
								<component type="gridLayout"
									name="reasonTypesCorrectionDateFromGridLayout" columns="3"
									rows="1">
									<layoutElement column="1" row="1">
										<component type="label" name="reasonTypesCorrectionDateFromLabel">
											<option type="labelStyle" value="label" />
										</component>
									</layoutElement>
									<layoutElement column="2" row="1" width="2">
										<component type="awesomeDynamicList" name="reasonTypesCorrectionDateFrom"
											source="#{form}.reasonTypesCorrectionDateFrom" reference="reasonTypesCorrectionDateFrom"
											defaultEnabled="false">
											<option type="hasBorder" value="false" />
											<option type="hasButtons" value="true" />

											<components>
												<component type="gridLayout"
													name="reasonTypeOfChangingOrderStateGridLayout" columns="1"
													rows="1">
													<layoutElement column="1" row="1">
														<component type="select" name="reasonTypeOfChangingOrderState"
															field="reasonTypeOfChangingOrderState" hasLabel="false" />
													</layoutElement>
												</component>
											</components>
										</component>
									</layoutElement>
								</component>
							</layoutElement>
							<layoutElement column="1" row="2" height="2">
								<component type="textarea" name="commentReasonTypeCorrectionDateFrom"
									field="#{form}.commentReasonTypeCorrectionDateFrom" reference="commentReasonTypeCorrectionDateFrom"
									defaultEnabled="false">
								</component>
							</layoutElement>
						</component>

						<option type="label" value="causeOfPlannedDateFromCorrectionLabel" />
					</component>
					<component type="borderLayout" name="causeDeviationsOfEffectiveStart">
						<component type="gridLayout"
							name="causeDeviationsOfEffectiveStartGridLayout" columns="1"
							rows="3" reference="causeDeviationsOfEffectiveStartGridLayout">
							<layoutElement column="1" row="1">
								<component type="gridLayout"
									name="reasonTypeDeviationsOfEffectiveStartGridLayout" columns="3"
									rows="1">
									<layoutElement column="1" row="1">
										<component type="label"
											name="reasonTypesDeviationsOfEffectiveStartLabel">
											<option type="labelStyle" value="label" />
										</component>
									</layoutElement>
									<layoutElement column="2" row="1" width="2">
										<component type="awesomeDynamicList"
											name="reasonTypesDeviationsOfEffectiveStart" source="#{form}.reasonTypesDeviationsOfEffectiveStart"
											reference="reasonTypesDeviationsOfEffectiveStart"
											defaultEnabled="false">
											<option type="hasBorder" value="false" />
											<option type="hasButtons" value="true" />

											<components>
												<component type="gridLayout"
													name="reasonTypeOfChangingOrderStateGridLayout" columns="1"
													rows="1">
													<layoutElement column="1" row="1">
														<component type="select" name="reasonTypeOfChangingOrderState"
															field="reasonTypeOfChangingOrderState" hasLabel="false" />
													</layoutElement>
												</component>
											</components>
										</component>
									</layoutElement>
								</component>
							</layoutElement>
							<layoutElement column="1" row="2" height="2">
								<component type="textarea"
									field="#{form}.commentReasonDeviationEffectiveStart" name="commentReasonTypeDeviationsOfEffectiveStart"
									reference="commentReasonTypeDeviationsOfEffectiveStart"
									defaultEnabled="false">
								</component>
							</layoutElement>
						</component>

						<option type="label" value="causeDeviationsOfEffectiveStartLabel" />
					</component>
				</layoutElement>
				<layoutElement column="2" row="1">
					<component type="borderLayout" name="endDates">
						<component type="gridLayout" name="endDatesGridLayout"
							columns="1" rows="3" reference="endDatesGridLayout">
							<layoutElement column="1" row="1">
								<component type="calendar" name="plannedDateTo" field="#{form}.dateTo"
									reference="plannedDateTo" defaultEnabled="false">
									<option type="withTimePicker" value="true" />

									<listener event="onChange"
										class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
										method="copyEndDate" />
								</component>
							</layoutElement>
							<layoutElement column="1" row="2">
								<component type="calendar" name="correctedDateTo"
									field="#{form}.correctedDateTo" reference="correctedDateTo"
									defaultEnabled="false">
									<option type="withTimePicker" value="true" />

									<listener event="onChange"
										class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
										method="copyEndDate" />
								</component>
							</layoutElement>
							<layoutElement column="1" row="3">
								<component type="calendar" name="effectiveDateTo"
									field="#{form}.effectiveDateTo" reference="effectiveDateTo"
									defaultEnabled="false">
									<option type="withTimePicker" value="true" />

									<listener event="onChange"
										class="com.qcadoo.mes.orders.listeners.OrderDetailsListeners"
										method="copyEndDate" />
								</component>
							</layoutElement>
						</component>

						<option type="label" value="endDatesLabel" />
					</component>
					<component type="borderLayout" name="causeOfPlannedDateToCorrection">
						<component type="gridLayout"
							name="causeOfPlannedDateToCorrectionGridLayout" columns="1" rows="3"
							reference="causeOfPlannedDateToCorrectionGridLayout">
							<layoutElement column="1" row="1">
								<component type="gridLayout"
									name="reasonTypesCorrectionDateToGridLayout" columns="3" rows="1">
									<layoutElement column="1" row="1">
										<component type="label" name="reasonTypesCorrectionDateToLabel">
											<option type="labelStyle" value="label" />
										</component>
									</layoutElement>
									<layoutElement column="2" row="1" width="2">
										<component type="awesomeDynamicList" name="reasonTypesCorrectionDateTo"
											source="#{form}.reasonTypesCorrectionDateTo" reference="reasonTypesCorrectionDateTo"
											defaultEnabled="false">
											<option type="hasBorder" value="false" />
											<option type="hasButtons" value="true" />

											<components>
												<component type="gridLayout"
													name="reasonTypeOfChangingOrderStateGridLayout" columns="1"
													rows="1">
													<layoutElement column="1" row="1">
														<component type="select" name="reasonTypeOfChangingOrderState"
															field="reasonTypeOfChangingOrderState" hasLabel="false" />
													</layoutElement>
												</component>
											</components>
										</component>
									</layoutElement>
								</component>
							</layoutElement>
							<layoutElement column="1" row="2" height="2">
								<component type="textarea" name="commentReasonTypeCorrectionDateTo"
									field="#{form}.commentReasonTypeCorrectionDateTo" reference="commentReasonTypeCorrectionDateTo"
									defaultEnabled="false">
								</component>
							</layoutElement>
						</component>

						<option type="label" value="causeOfPlannedDateToCorrectionLabel" />
					</component>
					<component type="borderLayout" name="causeDeviationsOfEffectiveEnd">
						<component type="gridLayout"
							name="causeDeviationsOfEffectiveEndGridLayout" columns="1" rows="3"
							reference="causeDeviationsOfEffectiveEndGridLayout">
							<layoutElement column="1" row="1">
								<component type="gridLayout"
									name="reasonTypeDeviationsOfEffectiveEndGridLayout" columns="3"
									rows="1">
									<layoutElement column="1" row="1">
										<component type="label"
											name="reasonTypesDeviationsOfEffectiveEndLabel">
											<option type="labelStyle" value="label" />
										</component>
									</layoutElement>
									<layoutElement column="2" row="1" width="2">
										<component type="awesomeDynamicList"
											name="reasonTypesDeviationsOfEffectiveEnd" source="#{form}.reasonTypesDeviationsOfEffectiveEnd"
											reference="reasonTypesDeviationsOfEffectiveEnd"
											defaultEnabled="false">
											<option type="hasBorder" value="false" />
											<option type="hasButtons" value="true" />

											<components>
												<component type="gridLayout"
													name="reasonTypeOfChangingOrderStateGridLayout" columns="1"
													rows="1">
													<layoutElement column="1" row="1">
														<component type="select" name="reasonTypeOfChangingOrderState"
															field="reasonTypeOfChangingOrderState" hasLabel="false" />
													</layoutElement>
												</component>
											</components>
										</component>
									</layoutElement>
								</component>
							</layoutElement>
							<layoutElement column="1" row="2" height="2">
								<component type="textarea"
									field="#{form}.commentReasonDeviationEffectiveEnd" name="commentReasonTypeDeviationsOfEffectiveEnd"
									reference="commentReasonTypeDeviationsOfEffectiveEnd"
									defaultEnabled="false">
								</component>
							</layoutElement>
						</component>

						<option type="label" value="causeDeviationsOfEffectiveEndLabel" />
					</component>
				</layoutElement>
			</component>
		</windowTab>

		<windowTab name="productQuantityTab">
			<component type="gridLayout" name="productQuantityTablayout"
				columns="3" rows="3">
				<layoutElement column="1" row="1" height="3">
					<component type="gridLayout" name="prodQuantityTablayout"
						columns="1" rows="3">
						<layoutElement column="1" row="1">
							<component type="borderLayout" name="commissionedAmount">
								<component type="gridLayout" name="commissionedAmountGridLayout"
									columns="4" rows="2" reference="commissionedAmountGridLayout"
									hasBorders="false">
									<layoutElement column="1" row="1" width="3">
										<component type="input" name="commissionedPlannedQuantity"
											reference="commissionedPlannedQuantity" field="#{form}.commissionedPlannedQuantity">
											<option type="labelWidth" value="55" />
											<option type="alignment" value="right" />
										</component>
									</layoutElement>
									<layoutElement column="4" row="1">
										<component type="input" name="unitCPQ" reference="unitCPQ"
											hasLabel="false">
											<option type="textRepresentationOnDisabled" value="true" />
										</component>
									</layoutElement>
									<layoutElement column="1" row="2" width="3">
										<component type="input" name="commissionedCorrectedQuantity"
											reference="commissionedCorrectedQuantity" field="#{form}.commissionedCorrectedQuantity">
											<option type="labelWidth" value="55" />
											<option type="alignment" value="right" />
										</component>
									</layoutElement>
									<layoutElement column="4" row="2">
										<component type="input" name="unitCCQ" reference="unitCCQ"
											hasLabel="false">
											<option type="textRepresentationOnDisabled" value="true" />
										</component>
									</layoutElement>
								</component>
								<option type="label" value="commissionedAmountLabel" />
							</component>
						</layoutElement>
						<layoutElement column="1" row="2">
							<component type="gridLayout" name="amountOfProductProducedGridLayout"
								columns="4" rows="1" reference="amountOfProductProducedGridLayout"
								hasBorders="false">
								<layoutElement column="1" row="1" width="3">
									<component type="input" name="amountOfProductProduced"
										reference="amountOfProductProduced" field="#{form}.amountOfProductProduced">
										<option type="labelWidth" value="55" />
										<option type="alignment" value="right" />
									</component>
								</layoutElement>
								<layoutElement column="4" row="1">
									<component type="input" name="unitAOPP" reference="unitAOPP"
										hasLabel="false">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
							</component>
						</layoutElement>
						<layoutElement column="1" row="3">
							<component type="gridLayout"
								name="remainingAmountOfProductToProduceGridLayout" columns="4"
								rows="1" reference="remainingAmountOfProductToProduceGridLayout"
								hasBorders="false">
								<layoutElement column="1" row="1" width="3">
									<component type="input" name="remainingAmountOfProductToProduce"
										reference="remainingAmountOfProductToProduce" field="#{form}.remainingAmountOfProductToProduce"
										defaultEnabled="never">
										<option type="labelWidth" value="55" />
										<option type="alignment" value="right" />
									</component>
								</layoutElement>
								<layoutElement column="4" row="1">
									<component type="input" name="unitRAOPTP" reference="unitRAOPTP"
										hasLabel="false">
										<option type="textRepresentationOnDisabled" value="true" />
									</component>
								</layoutElement>
							</component>
						</layoutElement>
					</component>
				</layoutElement>
				<layoutElement column="2" row="1" height="3">
					<component type="borderLayout" name="reasonForCorrectionBorderLayout">
						<component type="gridLayout" name="productQuantityGridLayout"
							columns="3" rows="3">
							<layoutElement column="1" row="1">
								<component type="label"
									name="reasonTypesCorrectionProductQuantityFromLabel">
									<option type="labelStyle" value="label" />
								</component>
							</layoutElement>
							<layoutElement column="2" row="1" width="2">
								<component type="awesomeDynamicList" name="typeOfCorrectionCauses"
									source="#{form}.typeOfCorrectionCauses" reference="typeOfCorrectionCauses">
									<option type="hasBorder" value="false" />
									<option type="hasButtons" value="true" />

									<components>
										<component type="gridLayout" name="productQuantityGridLayout"
											columns="1" rows="1">
											<layoutElement column="1" row="1">
												<component type="select" name="reasonType" field="reasonType"
													reference="reasonType" hasLabel="false">
												</component>
											</layoutElement>
										</component>
									</components>
								</component>
							</layoutElement>
							<layoutElement column="1" row="2" height="2" width="3">
								<component type="textarea" name="commentReasonTypeDeviationsQuantity"
									field="#{form}.commentReasonTypeDeviationsQuantity" reference="commentReasonTypeDeviationsQuantity">
								</component>
							</layoutElement>
						</component>
						<option type="label" value="reasonForCorrectionLabel" />
					</component>
				</layoutElement>
			</component>
		</windowTab>

		<windowTab name="history">
			<component type="grid" name="loggings" reference="grid"
				source="#{form}.stateChanges">
				<option type="column" name="dateAndTime" fields="dateAndTime"
					link="true" />
				<option type="column" name="previousState" fields="sourceState" />
				<option type="column" name="currentState" fields="targetState" />
				<option type="column" name="worker" fields="worker" />
				<option type="column" name="comment" fields="comment" />

				<option type="order" column="dateAndTime" direction="asc" />

				<option type="searchable" value="dateAndTime,previousState,currentState" />
				<option type="orderable" value="dateAndTime,previousState,currentState" />

				<option type="correspondingView" value="orders/orderStateChangeDetails" />
				<option type="correspondingComponent" value="form" />
			</component>
		</windowTab>

		<windowTab name="integrationTab">
			<script>
					<![CDATA[
						var del = #{window}.getRibbonItem("actions.delete");
						var externalNumberListener = {
							onSetValue: function(value) {
								
								var externalNumber = #{externalNumber}.getValue().content.value;
								
								if(externalNumber != undefined && externalNumber != '') {
									del.disable("#{translate(orders.order.ribbon.message.orderIsExternal)}");
								}
							}
						};
						#{form}.addOnChangeListener(externalNumberListener);
					]]>
			</script>
			<component type="gridLayout" name="gridLayout" columns="3"
				rows="1">
				<layoutElement column="1" row="1">
					<component type="input" name="externalNumber" field="#{form}.externalNumber"
						reference="externalNumber" defaultEnabled="never" />
				</layoutElement>
			</component>
		</windowTab>

	</component>

	<hooks>
		<beforeRender class="com.qcadoo.mes.orders.hooks.OrderDetailsHooks"
			method="onBeforeRender" />
	</hooks>

</view>